
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>ICESat-2 Active Subglacial Lakes in Antarctica &#8212; DeepIceDrain</title>
    
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">
<link href="../_static/styles/pydata-sphinx-theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">

    
  <link rel="stylesheet"
    href="../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" href="../_static/styles/sphinx-book-theme.css?digest=5115cc725059bd94278eecd172e13a965bf8f5a9" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../_static/design-style.b7bb847fb20b106c3d81b95245e65545.min.css" />
    
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf">

    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/clipboard.min.js"></script>
    <script src="../_static/copybutton.js"></script>
    <script src="../_static/scripts/sphinx-book-theme.js?digest=9c920249402e914e316237a7dbc6769907cce411"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../_static/togglebutton.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="../_static/design-tabs.js"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="../_static/sphinx-thebe.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Model Training" href="training.html" />
    <link rel="prev" title="Data Preparation" href="data.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="None">
    

    <!-- Google Analytics -->
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="60">
<!-- Checkboxes to toggle the left sidebar -->
<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation" aria-label="Toggle navigation sidebar">
<label class="overlay overlay-navbar" for="__navigation">
    <div class="visually-hidden">Toggle navigation sidebar</div>
</label>
<!-- Checkboxes to toggle the in-page toc -->
<input type="checkbox" class="sidebar-toggle" name="__page-toc" id="__page-toc" aria-label="Toggle in-page Table of Contents">
<label class="overlay overlay-pagetoc" for="__page-toc">
    <div class="visually-hidden">Toggle in-page Table of Contents</div>
</label>
<!-- Headers at the top -->
<div class="announcement header-item noprint"></div>
<div class="header header-item noprint"></div>

    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<!-- Sidebar -->
<div class="bd-sidebar noprint" id="site-navigation">
    <div class="bd-sidebar__content">
        <div class="bd-sidebar__top"><div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="../index.html">
      
        <!-- `logo` is deprecated in Sphinx 4.0, so remove this when we stop supporting 3 -->
        
      
      
      <img src="../_static/logo.svg" class="logo" alt="logo">
      
      
      <h1 class="site-logo" id="site-title">DeepIceDrain</h1>
      
    </a>
</div><form class="bd-search d-flex align-items-center" action="../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search this book..." aria-label="Search this book..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item active">
        <p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  About
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference external" href="https://geo-smart.github.io/index.html">
   Geosmart Website
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference external" href="https://foundations.projectpythia.org/landing-page.html">
   Project Pythia Foundations
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="about.html">
   About Use Case Library
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Chapter One
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="motivation.html">
   Motivation (Science or Utility)
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Chapter Two
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="methods.html">
   Machine Learning Methods and Tools
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Chapter Three
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="data.html">
   Data Preparation
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Chapter Four
 </span>
</p>
<ul class="current nav bd-sidenav">
 <li class="toctree-l1 current active">
  <a class="current reference internal" href="#">
   Model Development and Parameter Tuning
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Chapter Five
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="training.html">
   Model Training
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Chapter Six
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="evaluation.html">
   Performance Evaluation
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Chapter Seven
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="workflow.html">
   Workflow Management / Cloud Computing
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Chapter Eight
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="reproducibility.html">
   Reproducibility
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Chapter Nine
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="conclusion.html">
   Discussion / Conclusion
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Chapter Ten (optional)
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="todo.html">
   Try something on your own
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Chapter Eleven (optional)
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="questions.html">
   Open questions
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Chapter Twelve (optional)
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="troubleshooting.html">
   Trouble Shooting
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Chapter Thirteen
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="example.html">
   Sample Jupyter Notebook
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Reference
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../reference/glossary.html">
   Glossaries
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../reference/bibliography.html">
   Bibliography
  </a>
 </li>
</ul>

    </div>
</nav></div>
        <div class="bd-sidebar__bottom">
             <!-- To handle the deprecated key -->
            
            <div class="navbar_extra_footer">
            Powered by <a href="https://jupyterbook.org">Jupyter Book</a>
            </div>
            
        </div>
    </div>
    <div id="rtd-footer-container"></div>
</div>


          


          
<!-- A tiny helper pixel to detect if we've scrolled -->
<div class="sbt-scroll-pixel-helper"></div>
<!-- Main content -->
<div class="col py-0 content-container">
    
    <div class="header-article row sticky-top noprint">
        



<div class="col py-1 d-flex header-article-main">
    <div class="header-article__left">
        
        <label for="__navigation"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="right"
title="Toggle navigation"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-bars"></i>
  </span>

</label>

        
    </div>
    <div class="header-article__right">
<div class="menu-dropdown menu-dropdown-launch-buttons">
  <button class="headerbtn menu-dropdown__trigger"
      aria-label="Launch interactive content">
      <i class="fas fa-rocket"></i>
  </button>
  <div class="menu-dropdown__content">
    <ul>
      <li>
        <a href="https://mybinder.org/v2/gh/geo-smart/deepicedrainpipe/main?urlpath=lab/tree/book/chapters/04_dbscan.ipynb"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Launch on Binder"
>
  

<span class="headerbtn__icon-container">
  
    <img src="../_static/images/logo_binder.svg">
  </span>
<span class="headerbtn__text-container">Binder</span>
</a>

      </li>
      
    </ul>
  </div>
</div>

<button onclick="toggleFullScreen()"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="bottom"
title="Fullscreen mode"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>

<div class="menu-dropdown menu-dropdown-repository-buttons">
  <button class="headerbtn menu-dropdown__trigger"
      aria-label="Source repositories">
      <i class="fab fa-github"></i>
  </button>
  <div class="menu-dropdown__content">
    <ul>
      <li>
        <a href="https://github.com/geo-smart/deepicedrainpipe"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Source repository"
>
  

<span class="headerbtn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="headerbtn__text-container">repository</span>
</a>

      </li>
      
      <li>
        <a href="https://github.com/geo-smart/deepicedrainpipe/issues/new?title=Issue%20on%20page%20%2Fchapters/04_dbscan.html&body=Your%20issue%20content%20here."
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Open an issue"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="headerbtn__text-container">open issue</span>
</a>

      </li>
      
      <li>
        <a href="https://github.com/geo-smart/deepicedrainpipe/edit/main/book/chapters/04_dbscan.ipynb"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Edit this page"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-pencil-alt"></i>
  </span>
<span class="headerbtn__text-container">suggest edit</span>
</a>

      </li>
      
    </ul>
  </div>
</div>

<div class="menu-dropdown menu-dropdown-download-buttons">
  <button class="headerbtn menu-dropdown__trigger"
      aria-label="Download this page">
      <i class="fas fa-download"></i>
  </button>
  <div class="menu-dropdown__content">
    <ul>
      <li>
        <a href="../_sources/chapters/04_dbscan.ipynb"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Download source file"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="headerbtn__text-container">.ipynb</span>
</a>

      </li>
      
      <li>
        
<button onclick="printPdf(this)"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="left"
title="Print to PDF"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="headerbtn__text-container">.pdf</span>
</button>

      </li>
      
    </ul>
  </div>
</div>
<label for="__page-toc"
  class="headerbtn headerbtn-page-toc"
  
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-list"></i>
  </span>

</label>

    </div>
</div>

<!-- Table of contents -->
<div class="col-md-3 bd-toc show noprint">
    <div class="tocsection onthispage pt-5 pb-3">
        <i class="fas fa-list"></i> Contents
    </div>
    <nav id="bd-toc-nav" aria-label="Page">
        <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#load-in-icesat-2-data-x-y-dhdt-and-do-initial-trimming">
   Load in ICESat-2 data (x, y, dhdt) and do initial trimming
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#find-active-subglacial-lake-clusters">
   Find Active Subglacial Lake clusters
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#subglacial-lake-finder-algorithm">
     Subglacial Lake Finder algorithm
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#visualize-lakes">
   Visualize lakes
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#select-a-subglacial-lake-to-examine">
   Select a subglacial lake to examine
  </a>
 </li>
</ul>

    </nav>
</div>
    </div>
    <div class="article row">
        <div class="col pl-md-3 pl-lg-5 content-container">
            <!-- Table of contents that is only displayed when printing the page -->
            <div id="jb-print-docs-body" class="onlyprint">
                <h1>ICESat-2 Active Subglacial Lakes in Antarctica</h1>
                <!-- Table of contents -->
                <div id="print-main-content">
                    <div id="jb-print-toc">
                        
                        <div>
                            <h2> Contents </h2>
                        </div>
                        <nav aria-label="Page">
                            <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#load-in-icesat-2-data-x-y-dhdt-and-do-initial-trimming">
   Load in ICESat-2 data (x, y, dhdt) and do initial trimming
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#find-active-subglacial-lake-clusters">
   Find Active Subglacial Lake clusters
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#subglacial-lake-finder-algorithm">
     Subglacial Lake Finder algorithm
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#visualize-lakes">
   Visualize lakes
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#select-a-subglacial-lake-to-examine">
   Select a subglacial lake to examine
  </a>
 </li>
</ul>

                        </nav>
                    </div>
                </div>
            </div>
            <main id="main-content" role="main">
                
              <div>
                
  <section class="tex2jax_ignore mathjax_ignore" id="icesat-2-active-subglacial-lakes-in-antarctica">
<h1>ICESat-2 Active Subglacial Lakes in Antarctica<a class="headerlink" href="#icesat-2-active-subglacial-lakes-in-antarctica" title="Permalink to this headline">#</a></h1>
<p>Finding subglacial lakes that are draining or filling under the ice!
They can be detected with ICESat-2 data, as significant changes in height
(&gt; 1 metre) over a relatively short duration (&lt; 1 year), i.e. a high rate of
elevation change over time (dhdt).</p>
<p>In this notebook, we’ll use some neat tools to help us examine the lakes:</p>
<ul class="simple">
<li><p>To find active subglacial lake boundaries,
use an <em>unsupervised clustering</em> technique</p></li>
<li><p>To see ice surface elevation trends at a higher temporal resolution (&lt; 3 months),
perform <em>crossover track error analysis</em> on intersecting ICESat-2 tracks</p></li>
</ul>
<p>To speed up analysis on millions of points,
we will use state of the art GPU algorithms enabled by RAPIDS AI libraries,
or parallelize the processing across our HPC’s many CPU cores using Dask.</p>
<p>Note: This notebook was adapted from
<a class="reference external" href="https://github.com/weiji14/deepicedrain/blob/v0.4.2/atlxi_dhdt.ipynb">https://github.com/weiji14/deepicedrain/blob/v0.4.2/atlxi_dhdt.ipynb</a></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>

<span class="c1"># import cudf</span>
<span class="c1"># import cuml</span>
<span class="kn">import</span> <span class="nn">geopandas</span> <span class="k">as</span> <span class="nn">gpd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="c1"># import pygmt</span>
<span class="kn">import</span> <span class="nn">scipy.spatial</span>
<span class="kn">import</span> <span class="nn">shapely.geometry</span>
<span class="kn">import</span> <span class="nn">tqdm</span>

<span class="c1"># import deepicedrain</span>
</pre></div>
</div>
</div>
</div>
<section id="load-in-icesat-2-data-x-y-dhdt-and-do-initial-trimming">
<h2>Load in ICESat-2 data (x, y, dhdt) and do initial trimming<a class="headerlink" href="#load-in-icesat-2-data-x-y-dhdt-and-do-initial-trimming" title="Permalink to this headline">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Read in raw x, y, dhdt_slope and referencegroundtrack data into the GPU</span>
<span class="n">cudf_raw</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_parquet</span><span class="p">(</span>
    <span class="n">path</span><span class="o">=</span><span class="s2">&quot;https://github.com/weiji14/deepicedrain/releases/download/v0.4.2/df_dhdt_whillans_upstream.parquet&quot;</span><span class="p">,</span>
    <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="s2">&quot;dhdt_slope&quot;</span><span class="p">,</span> <span class="s2">&quot;referencegroundtrack&quot;</span><span class="p">],</span>
    <span class="c1"># filters=[[(&#39;dhdt_slope&#39;, &#39;&lt;&#39;, -0.105)], [(&#39;dhdt_slope&#39;, &#39;&gt;&#39;, 0.105)]],</span>
<span class="p">)</span>
<span class="c1"># Filter to points with dhdt that is less than -0.105 m/yr or more than +0.105 m/yr</span>
<span class="c1"># Based on ICESat-2 ATL06&#39;s accuracy and precision of 3.3 ± 7.2cm from Brunt et al 2020</span>
<span class="c1"># See https://doi.org/10.1029/2020GL090572</span>
<span class="n">cudf_many</span> <span class="o">=</span> <span class="n">cudf_raw</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="nb">abs</span><span class="p">(</span><span class="n">cudf_raw</span><span class="o">.</span><span class="n">dhdt_slope</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">0.105</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Trimmed </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">cudf_raw</span><span class="p">)</span><span class="si">}</span><span class="s2"> -&gt; </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">cudf_many</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="k">if</span> <span class="s2">&quot;cudf_raw&quot;</span> <span class="ow">in</span> <span class="nb">globals</span><span class="p">():</span>
    <span class="k">del</span> <span class="n">cudf_raw</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Trimmed 4400800 -&gt; 2781831
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Clip outlier values to 3 sigma (standard deviations) from mean</span>
<span class="n">_mean</span> <span class="o">=</span> <span class="n">cudf_many</span><span class="o">.</span><span class="n">dhdt_slope</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
<span class="n">_std</span> <span class="o">=</span> <span class="n">cudf_many</span><span class="o">.</span><span class="n">dhdt_slope</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
<span class="n">cudf_many</span><span class="o">.</span><span class="n">dhdt_slope</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span>
    <span class="n">lower</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">(</span><span class="n">_mean</span> <span class="o">-</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">_std</span><span class="p">),</span> <span class="n">upper</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">(</span><span class="n">_mean</span> <span class="o">+</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">_std</span><span class="p">)</span>
<span class="p">)</span>
<span class="n">X_many</span> <span class="o">=</span> <span class="n">cudf_many</span>
<span class="n">X_many</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>x</th>
      <th>y</th>
      <th>dhdt_slope</th>
      <th>referencegroundtrack</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>-674266.855575</td>
      <td>-400035.558755</td>
      <td>0.361657</td>
      <td>6</td>
    </tr>
    <tr>
      <th>1</th>
      <td>-674306.626769</td>
      <td>-400078.173573</td>
      <td>0.331515</td>
      <td>6</td>
    </tr>
    <tr>
      <th>2</th>
      <td>-674346.406781</td>
      <td>-400120.780361</td>
      <td>0.359910</td>
      <td>6</td>
    </tr>
    <tr>
      <th>3</th>
      <td>-674386.187284</td>
      <td>-400163.386740</td>
      <td>0.402465</td>
      <td>6</td>
    </tr>
    <tr>
      <th>4</th>
      <td>-674425.611742</td>
      <td>-400206.325432</td>
      <td>0.300734</td>
      <td>6</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>4476225</th>
      <td>-400216.802567</td>
      <td>-569525.939382</td>
      <td>0.284563</td>
      <td>1385</td>
    </tr>
    <tr>
      <th>4476226</th>
      <td>-400169.718641</td>
      <td>-569491.642818</td>
      <td>0.316296</td>
      <td>1385</td>
    </tr>
    <tr>
      <th>4476227</th>
      <td>-400122.633688</td>
      <td>-569457.347729</td>
      <td>0.334779</td>
      <td>1385</td>
    </tr>
    <tr>
      <th>4476228</th>
      <td>-400075.549059</td>
      <td>-569423.052244</td>
      <td>0.280224</td>
      <td>1385</td>
    </tr>
    <tr>
      <th>4476229</th>
      <td>-400028.465681</td>
      <td>-569388.755047</td>
      <td>0.138302</td>
      <td>1385</td>
    </tr>
  </tbody>
</table>
<p>2781831 rows × 4 columns</p>
</div></div></div>
</div>
</section>
<section id="find-active-subglacial-lake-clusters">
<h2>Find Active Subglacial Lake clusters<a class="headerlink" href="#find-active-subglacial-lake-clusters" title="Permalink to this headline">#</a></h2>
<p>Uses Density-based spatial clustering of applications with noise (DBSCAN).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">find_clusters</span><span class="p">(</span>
    <span class="n">X</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
    <span class="n">eps</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">3000</span><span class="p">,</span>
    <span class="n">min_samples</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">250</span><span class="p">,</span>
    <span class="n">output_colname</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;cluster_id&quot;</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Classify a point cloud into several groups, with each group being assigned</span>
<span class="sd">    a positive integer label like 1, 2, 3, etc. Unclassified noise points are</span>
<span class="sd">    labelled as NaN.</span>
<span class="sd">    Uses Density-based spatial clustering of applications with noise (DBSCAN).</span>
<span class="sd">    See also https://www.naftaliharris.com/blog/visualizing-dbscan-clustering</span>
<span class="sd">    ***       **         111       NN</span>
<span class="sd">    **    **   *         11    22   N</span>
<span class="sd">    *     ****     --&gt;   1     2222</span>
<span class="sd">      **     **            33     22</span>
<span class="sd">    ******               333333</span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    X : cudf.DataFrame or pandas.DataFrame</span>
<span class="sd">        A table of X, Y, Z points to run the clustering algorithm on.</span>
<span class="sd">    eps : float</span>
<span class="sd">        The maximum distance between 2 points such they reside in the same</span>
<span class="sd">        neighborhood. Default is 3000 (metres).</span>
<span class="sd">    min_samples : int</span>
<span class="sd">        The number of samples in a neighborhood such that this group can be</span>
<span class="sd">        considered as an important core point (including the point itself).</span>
<span class="sd">        Default is 250 (sample points).</span>
<span class="sd">    output_colname : str</span>
<span class="sd">        The name of the column for the output Series. Default is &#39;cluster_id&#39;.</span>
<span class="sd">    kwargs : dict</span>
<span class="sd">        Extra parameters to pass into the `cuml.cluster.DBSCAN` or</span>
<span class="sd">        `sklearn.cluster.DBSCAN` function.</span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    cluster_labels : cudf.Series or pd.Series</span>
<span class="sd">        Which cluster each datapoint belongs to. Noisy samples are labeled as</span>
<span class="sd">        NaN.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="kn">from</span> <span class="nn">cuml.cluster</span> <span class="kn">import</span> <span class="n">DBSCAN</span>
    <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
        <span class="kn">from</span> <span class="nn">sklearn.cluster</span> <span class="kn">import</span> <span class="n">DBSCAN</span>

    <span class="c1"># Run DBSCAN using {eps} m distance, and minimum of {min_samples} points</span>
    <span class="n">dbscan</span> <span class="o">=</span> <span class="n">DBSCAN</span><span class="p">(</span><span class="n">eps</span><span class="o">=</span><span class="n">eps</span><span class="p">,</span> <span class="n">min_samples</span><span class="o">=</span><span class="n">min_samples</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="n">dbscan</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X</span><span class="o">=</span><span class="n">X</span><span class="p">)</span>

    <span class="n">cluster_labels</span> <span class="o">=</span> <span class="n">dbscan</span><span class="o">.</span><span class="n">labels_</span> <span class="o">+</span> <span class="mi">1</span>  <span class="c1"># noise points -1 becomes 0</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cluster_labels</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
        <span class="n">cluster_labels</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">cluster_labels</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">Int32Dtype</span><span class="p">())</span>
    <span class="n">cluster_labels</span> <span class="o">=</span> <span class="n">cluster_labels</span><span class="o">.</span><span class="n">mask</span><span class="p">(</span><span class="n">cond</span><span class="o">=</span><span class="n">cluster_labels</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>  <span class="c1"># turn 0 to NaN</span>
    <span class="n">cluster_labels</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">index</span>  <span class="c1"># let labels have same index as input data</span>
    <span class="n">cluster_labels</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">output_colname</span>

    <span class="k">return</span> <span class="n">cluster_labels</span>
</pre></div>
</div>
</div>
</div>
<section id="subglacial-lake-finder-algorithm">
<h3>Subglacial Lake Finder algorithm<a class="headerlink" href="#subglacial-lake-finder-algorithm" title="Permalink to this headline">#</a></h3>
<p>For each Antarctic drainage basin:</p>
<ol class="simple">
<li><p>Select all points with significant elevation change over time (dhdt)</p></li>
</ol>
<ul class="simple">
<li><p>Specifically, the (absolute) dhdt value should be
2x the median (absolute) dhdt for that drainage basin</p></li>
<li><p>E.g. if median dhdt for basin is 0.35 m/yr,
we choose points that have dhdt &gt; 0.70 m/yr</p></li>
</ul>
<ol class="simple">
<li><p>Run unsupervised clustering to pick out active subglacial lakes</p></li>
</ol>
<ul class="simple">
<li><p>Split into draining (-dhdt) and filling (+dhdt) points first</p></li>
<li><p>Use DBSCAN algorithm to cluster points into groups,
with an eps (distance) of 3 km and minimum sample size of 250 points</p></li>
</ul>
<ol class="simple">
<li><p>Check each potential point cluster to see if it meets active lake criteria</p></li>
<li><p>Build a convex hull ‘lake’ polygon around clustered points</p></li>
<li><p>Check that the ‘lake’ has significant elevation change relative to outside
- For the area in the 5 km buffer region <strong>outside</strong> the ‘lake’ polygon:</p>
<ul class="simple">
<li><p>Find median dhdt (outer_dhdt)</p></li>
<li><p>Find median absolute deviation of dhdt values (outer_mad)</p></li>
</ul>
</li>
</ol>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>- For the area **inside** the &#39;lake&#39; polygon:
   - Find median dhdt (inner_dhdt)
- If the potential lake shows an elevation change that is more than
  3x the surrounding deviation of background elevation change,
  we infer that this is likely an active subglacial &#39;lake&#39;
</pre></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Subglacial lake finder</span>
<span class="n">activelakes</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{</span>
    <span class="c1"># &quot;basin_name&quot;: [],  # Antarctic drainage basin name</span>
    <span class="s2">&quot;refgtracks&quot;</span><span class="p">:</span> <span class="p">[],</span>  <span class="c1"># Pipe-delimited list of ICESat-2 reference ground tracks</span>
    <span class="s2">&quot;num_points&quot;</span><span class="p">:</span> <span class="p">[],</span>  <span class="c1"># Number of clustered data points</span>
    <span class="s2">&quot;maxabsdhdt&quot;</span><span class="p">:</span> <span class="p">[],</span>  <span class="c1"># Maximum absolute dhdt value inside of lake boundary</span>
    <span class="s2">&quot;inner_dhdt&quot;</span><span class="p">:</span> <span class="p">[],</span>  <span class="c1"># Median elev change over time (dhdt) inside of lake bounds</span>
    <span class="s2">&quot;mean_dhdt&quot;</span><span class="p">:</span> <span class="p">[],</span>  <span class="c1"># Mean elev change over time (dhdt) inside of lake bounds</span>
    <span class="s2">&quot;outer_dhdt&quot;</span><span class="p">:</span> <span class="p">[],</span>  <span class="c1"># Median elevation change over time (dhdt) outside of lake</span>
    <span class="s2">&quot;outer_std&quot;</span><span class="p">:</span> <span class="p">[],</span>  <span class="c1"># Standard deviation of dhdt outside of lake</span>
    <span class="s2">&quot;outer_mad&quot;</span><span class="p">:</span> <span class="p">[],</span>  <span class="c1"># Median absolute deviation of dhdt outside of lake</span>
    <span class="s2">&quot;geometry&quot;</span><span class="p">:</span> <span class="p">[],</span>  <span class="c1"># Shapely Polygon geometry holding lake boundary coordinates</span>
<span class="p">}</span>
<span class="c1"># basin_name: str = &quot;Cook&quot;  # Set a basin name here</span>
<span class="c1"># basins = drainage_basins[drainage_basins.NAME == basin_name].index  # one specific basin</span>
<span class="c1"># basins = drainage_basins[</span>
<span class="c1">#     drainage_basins.NAME.isin((&quot;Cook&quot;, &quot;Whillans&quot;))</span>
<span class="c1"># ].index  # some specific basins</span>
<span class="c1"># basins: pd.core.indexes.numeric.Int64Index = drainage_basins.index  # run on all basins</span>

<span class="n">eps</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">3000</span>  <span class="c1"># ICESat-2 tracks are separated by ~3 km across track, with each laser pair ~90 m apart</span>
<span class="n">min_samples</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">300</span>
<span class="k">for</span> <span class="n">basin_index</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="o">.</span><span class="n">tqdm</span><span class="p">(</span><span class="n">iterable</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
    <span class="c1"># Initial data cleaning, filter to rows that are in the drainage basin</span>
    <span class="c1"># basin = drainage_basins.loc[basin_index]</span>
    <span class="n">X_local</span> <span class="o">=</span> <span class="n">X_many</span> <span class="c1">#.loc[X_many.drainage_basin == basin.NAME]  # .reset_index(drop=True)</span>

    <span class="c1"># Get points with dhdt_slope higher than 3x the median dhdt_slope for the basin</span>
    <span class="c1"># E.g. if median dhdt_slope is 0.30 m/yr, then we cluster points over 0.90 m/yr</span>
    <span class="n">abs_dhdt</span> <span class="o">=</span> <span class="n">X_local</span><span class="o">.</span><span class="n">dhdt_slope</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span>
    <span class="n">tolerance</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">abs_dhdt</span><span class="o">.</span><span class="n">median</span><span class="p">()</span>
    <span class="n">X</span> <span class="o">=</span> <span class="n">X_local</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">abs_dhdt</span> <span class="o">&gt;</span> <span class="n">tolerance</span><span class="p">]</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">X</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">1000</span><span class="p">:</span>  <span class="c1"># don&#39;t run on too few points</span>
        <span class="k">continue</span>

    <span class="c1"># Run unsupervised clustering separately on draining and filling lakes</span>
    <span class="c1"># Draining lake points have negative labels (e.g. -1, -2, 3),</span>
    <span class="c1"># Filling lake points have positive labels (e.g. 1, 2, 3),</span>
    <span class="c1"># Noise points have NaN labels (i.e. NaN)</span>
    <span class="n">cluster_vars</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="s2">&quot;dhdt_slope&quot;</span><span class="p">]</span>
    <span class="n">draining_lake_labels</span> <span class="o">=</span> <span class="o">-</span><span class="n">find_clusters</span><span class="p">(</span>
        <span class="n">X</span><span class="o">=</span><span class="n">X</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">X</span><span class="o">.</span><span class="n">dhdt_slope</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">][</span><span class="n">cluster_vars</span><span class="p">],</span>
        <span class="n">eps</span><span class="o">=</span><span class="n">eps</span><span class="p">,</span>
        <span class="n">min_samples</span><span class="o">=</span><span class="n">min_samples</span><span class="p">,</span>
        <span class="c1"># verbose=cuml.common.logger.level_error,</span>
    <span class="p">)</span>
    <span class="n">filling_lake_labels</span> <span class="o">=</span> <span class="n">find_clusters</span><span class="p">(</span>
        <span class="n">X</span><span class="o">=</span><span class="n">X</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">X</span><span class="o">.</span><span class="n">dhdt_slope</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">][</span><span class="n">cluster_vars</span><span class="p">],</span>
        <span class="n">eps</span><span class="o">=</span><span class="n">eps</span><span class="p">,</span>
        <span class="n">min_samples</span><span class="o">=</span><span class="n">min_samples</span><span class="p">,</span>
        <span class="c1"># verbose=cuml.common.logger.level_error,</span>
    <span class="p">)</span>
    <span class="n">lake_labels</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">objs</span><span class="o">=</span><span class="p">[</span><span class="n">draining_lake_labels</span><span class="p">,</span> <span class="n">filling_lake_labels</span><span class="p">])</span>
    <span class="n">lake_labels</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span> <span class="o">=</span> <span class="n">lake_labels</span><span class="o">.</span><span class="n">sort_index</span><span class="p">()</span>
    <span class="k">assert</span> <span class="n">lake_labels</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;cluster_id&quot;</span>

    <span class="c1"># Checking all potential subglacial lakes in a basin</span>
    <span class="n">clusters</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span> <span class="o">=</span> <span class="n">lake_labels</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">cluster_label</span> <span class="ow">in</span> <span class="n">clusters</span><span class="p">:</span>
        <span class="c1"># Store attribute and geometry information of each active lake</span>
        <span class="n">lake_points</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">lake_labels</span> <span class="o">==</span> <span class="n">cluster_label</span><span class="p">]</span>

        <span class="c1"># More data cleaning, dropping clusters with too few points</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">lake_points</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">100</span>
        <span class="k">except</span> <span class="ne">AssertionError</span><span class="p">:</span>
            <span class="n">lake_labels</span> <span class="o">=</span> <span class="n">lake_labels</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">to_replace</span><span class="o">=</span><span class="n">cluster_label</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
            <span class="k">continue</span>

        <span class="n">multipoint</span><span class="p">:</span> <span class="n">shapely</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">MultiPoint</span> <span class="o">=</span> <span class="n">shapely</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">MultiPoint</span><span class="p">(</span>
            <span class="n">points</span><span class="o">=</span><span class="n">lake_points</span><span class="p">[[</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span>  <span class="c1"># .as_matrix()</span>
        <span class="p">)</span>
        <span class="n">convexhull</span><span class="p">:</span> <span class="n">shapely</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">Polygon</span> <span class="o">=</span> <span class="n">multipoint</span><span class="o">.</span><span class="n">convex_hull</span>

        <span class="c1"># Filter out (most) false positive subglacial lakes</span>
        <span class="c1"># Check that elevation change over time in lake is anomalous to outside</span>
        <span class="c1"># The 5000 m distance from lake boundary setting is empirically based on</span>
        <span class="c1"># Smith et al. 2009&#39;s methodology at https://doi.org/10.3189/002214309789470879</span>
        <span class="n">outer_ring_buffer</span> <span class="o">=</span> <span class="n">convexhull</span><span class="o">.</span><span class="n">buffer</span><span class="p">(</span><span class="n">distance</span><span class="o">=</span><span class="mi">5000</span><span class="p">)</span> <span class="o">-</span> <span class="n">convexhull</span>
        <span class="n">X_local</span><span class="p">[</span><span class="s2">&quot;in_donut_ring&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">deepicedrain</span><span class="o">.</span><span class="n">point_in_polygon_gpu</span><span class="p">(</span>
            <span class="n">points_df</span><span class="o">=</span><span class="n">X_local</span><span class="p">,</span>
            <span class="n">poly_df</span><span class="o">=</span><span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">({</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s2">&quot;geometry&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">outer_ring_buffer</span><span class="p">]}),</span>
        <span class="p">)</span>
        <span class="n">outer_points</span> <span class="o">=</span> <span class="n">X_local</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="s2">&quot;in_donut_ring&quot;</span><span class="p">)</span>
        <span class="n">outer_dhdt</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">outer_points</span><span class="o">.</span><span class="n">dhdt_slope</span><span class="o">.</span><span class="n">median</span><span class="p">()</span>

        <span class="n">outer_std</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">outer_points</span><span class="o">.</span><span class="n">dhdt_slope</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
        <span class="n">outer_mad</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">median_abs_deviation</span><span class="p">(</span>
            <span class="n">x</span><span class="o">=</span><span class="n">outer_points</span><span class="o">.</span><span class="n">dhdt_slope</span><span class="o">.</span><span class="n">to_pandas</span><span class="p">()</span>
        <span class="p">)</span>

        <span class="n">mean_dhdt</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">lake_points</span><span class="o">.</span><span class="n">dhdt_slope</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="n">inner_dhdt</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">lake_points</span><span class="o">.</span><span class="n">dhdt_slope</span><span class="o">.</span><span class="n">median</span><span class="p">()</span>
        <span class="n">X_local</span> <span class="o">=</span> <span class="n">X_local</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">labels</span><span class="o">=</span><span class="s2">&quot;in_donut_ring&quot;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="s2">&quot;columns&quot;</span><span class="p">)</span>

        <span class="c1"># If lake interior&#39;s median dhdt value is within 3 median absolute deviations</span>
        <span class="c1"># of the lake exterior&#39;s dhdt value, we remove the lake label</span>
        <span class="c1"># I.e. skip if above background change not significant enough</span>
        <span class="c1"># Inspired by Kim et al. 2016&#39;s methodology at https://doi.org/10.5194/tc-10-2971-2016</span>
        <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">inner_dhdt</span> <span class="o">-</span> <span class="n">outer_dhdt</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">outer_mad</span><span class="p">:</span>
            <span class="n">lake_labels</span> <span class="o">=</span> <span class="n">lake_labels</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">to_replace</span><span class="o">=</span><span class="n">cluster_label</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
            <span class="k">continue</span>

        <span class="n">maxabsdhdt</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">lake_points</span><span class="o">.</span><span class="n">dhdt_slope</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">cluster_label</span> <span class="o">&gt;</span> <span class="mi">0</span>  <span class="c1"># positive label = filling</span>
            <span class="k">else</span> <span class="n">lake_points</span><span class="o">.</span><span class="n">dhdt_slope</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>  <span class="c1"># negative label = draining</span>
        <span class="p">)</span>
        <span class="n">refgtracks</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;|&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">lake_points</span><span class="o">.</span><span class="n">referencegroundtrack</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span><span class="o">.</span><span class="n">to_pandas</span><span class="p">())</span>
        <span class="p">)</span>

        <span class="c1"># Save key variables to dictionary that will later go into geodataframe</span>
        <span class="n">activelakes</span><span class="p">[</span><span class="s2">&quot;basin_name&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">basin</span><span class="o">.</span><span class="n">NAME</span><span class="p">)</span>
        <span class="n">activelakes</span><span class="p">[</span><span class="s2">&quot;refgtracks&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">refgtracks</span><span class="p">)</span>
        <span class="n">activelakes</span><span class="p">[</span><span class="s2">&quot;num_points&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">lake_points</span><span class="p">))</span>
        <span class="n">activelakes</span><span class="p">[</span><span class="s2">&quot;maxabsdhdt&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">maxabsdhdt</span><span class="p">)</span>
        <span class="n">activelakes</span><span class="p">[</span><span class="s2">&quot;inner_dhdt&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">inner_dhdt</span><span class="p">)</span>
        <span class="n">activelakes</span><span class="p">[</span><span class="s2">&quot;mean_dhdt&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mean_dhdt</span><span class="p">)</span>
        <span class="n">activelakes</span><span class="p">[</span><span class="s2">&quot;outer_dhdt&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">outer_dhdt</span><span class="p">)</span>
        <span class="n">activelakes</span><span class="p">[</span><span class="s2">&quot;outer_std&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">outer_std</span><span class="p">)</span>
        <span class="n">activelakes</span><span class="p">[</span><span class="s2">&quot;outer_mad&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">outer_mad</span><span class="p">)</span>
        <span class="n">activelakes</span><span class="p">[</span><span class="s2">&quot;geometry&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">convexhull</span><span class="p">)</span>

    <span class="c1"># Calculate total number of lakes found for one drainage basin</span>
    <span class="n">clusters</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span> <span class="o">=</span> <span class="n">lake_labels</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
    <span class="n">n_draining</span><span class="p">,</span> <span class="n">n_filling</span> <span class="o">=</span> <span class="p">(</span><span class="n">clusters</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(),</span> <span class="p">(</span><span class="n">clusters</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">n_draining</span> <span class="o">+</span> <span class="n">n_filling</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">X</span><span class="p">)</span><span class="si">}</span><span class="s2"> rows at </span><span class="si">{</span><span class="n">basin</span><span class="o">.</span><span class="n">NAME</span><span class="si">}</span><span class="s2"> above ± </span><span class="si">{</span><span class="n">tolerance</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> m/yr&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">n_draining</span><span class="si">}</span><span class="s2"> draining and </span><span class="si">{</span><span class="n">n_filling</span><span class="si">}</span><span class="s2"> filling lakes found&quot;</span><span class="p">)</span>

<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">activelakes</span><span class="p">[</span><span class="s2">&quot;geometry&quot;</span><span class="p">])</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
    <span class="n">gdf</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">(</span><span class="n">activelakes</span><span class="p">,</span> <span class="n">crs</span><span class="o">=</span><span class="s2">&quot;EPSG:3031&quot;</span><span class="p">)</span>
    <span class="n">basename</span> <span class="o">=</span> <span class="s2">&quot;antarctic_subglacial_lakes&quot;</span>  <span class="c1"># f&quot;temp_{basin_name.lower()}_lakes&quot;  #</span>
    <span class="n">gdf</span><span class="o">.</span><span class="n">to_file</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">basename</span><span class="si">}</span><span class="s2">_3031.geojson&quot;</span><span class="p">,</span> <span class="n">driver</span><span class="o">=</span><span class="s2">&quot;GeoJSON&quot;</span><span class="p">)</span>
    <span class="n">gdf</span><span class="o">.</span><span class="n">to_crs</span><span class="p">(</span><span class="n">crs</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;init&quot;</span><span class="p">:</span> <span class="s2">&quot;epsg:4326&quot;</span><span class="p">})</span><span class="o">.</span><span class="n">to_file</span><span class="p">(</span>
        <span class="n">filename</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">basename</span><span class="si">}</span><span class="s2">_4326.geojson&quot;</span><span class="p">,</span> <span class="n">driver</span><span class="o">=</span><span class="s2">&quot;GeoJSON&quot;</span>
    <span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Total of </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">gdf</span><span class="p">)</span><span class="si">}</span><span class="s2"> subglacial lakes found&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  1%|          | 2/198 [00:01&lt;02:57,  1.10it/s]
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>102075 rows at Academy above ± 0.44 m/yr
2 draining and 9 filling lakes found
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  6%|▌         | 12/198 [00:02&lt;00:25,  7.38it/s]
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>37918 rows at Jutulstraumen above ± 0.58 m/yr
0 draining and 1 filling lakes found
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> 27%|██▋       | 54/198 [00:07&lt;00:17,  8.03it/s]
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>70286 rows at Cook above ± 0.51 m/yr
0 draining and 1 filling lakes found
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> 28%|██▊       | 56/198 [00:08&lt;00:18,  7.64it/s]
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>39403 rows at David above ± 0.50 m/yr
1 draining and 1 filling lakes found
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> 30%|███       | 60/198 [00:09&lt;00:31,  4.37it/s]
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>90734 rows at Mercer above ± 0.55 m/yr
5 draining and 15 filling lakes found
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> 31%|███▏      | 62/198 [00:09&lt;00:24,  5.58it/s]
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>288050 rows at Pine_Island above ± 0.97 m/yr
2 draining and 1 filling lakes found
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> 33%|███▎      | 66/198 [00:19&lt;02:36,  1.19s/it]
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>160978 rows at Thwaites above ± 0.78 m/yr
4 draining and 3 filling lakes found
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> 35%|███▌      | 70/198 [00:20&lt;01:19,  1.62it/s]
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>126226 rows at Whillans above ± 0.64 m/yr
6 draining and 13 filling lakes found
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> 36%|███▋      | 72/198 [00:23&lt;01:50,  1.14it/s]
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>63649 rows at Kamb above ± 0.54 m/yr
2 draining and 12 filling lakes found
6238 rows at Leverett above ± 0.61 m/yr
1 draining and 0 filling lakes found
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> 37%|███▋      | 74/198 [00:24&lt;01:36,  1.28it/s]
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>86214 rows at Scott above ± 0.51 m/yr
5 draining and 8 filling lakes found
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> 39%|███▉      | 77/198 [00:25&lt;01:02,  1.93it/s]
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>58941 rows at Amundsen above ± 0.51 m/yr
4 draining and 5 filling lakes found
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> 41%|████      | 81/198 [00:25&lt;00:38,  3.01it/s]
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>77517 rows at Beardmore above ± 0.48 m/yr
2 draining and 2 filling lakes found
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> 41%|████▏     | 82/198 [00:26&lt;00:40,  2.84it/s]
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>66146 rows at Nimrod above ± 0.48 m/yr
2 draining and 0 filling lakes found
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> 43%|████▎     | 86/198 [00:27&lt;00:31,  3.61it/s]
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>96005 rows at Byrd above ± 0.47 m/yr
5 draining and 5 filling lakes found
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> 45%|████▍     | 89/198 [00:27&lt;00:23,  4.62it/s]
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>26337 rows at Bindschadler above ± 0.46 m/yr
2 draining and 1 filling lakes found
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> 46%|████▌     | 91/198 [00:28&lt;00:24,  4.44it/s]
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>49745 rows at MacAyeal above ± 0.47 m/yr
4 draining and 3 filling lakes found
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> 56%|█████▌    | 110/198 [00:29&lt;00:07, 12.29it/s]
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>7570 rows at Bailey above ± 0.49 m/yr
0 draining and 1 filling lakes found
47112 rows at Slessor above ± 0.47 m/yr
12 draining and 5 filling lakes found
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> 57%|█████▋    | 112/198 [00:30&lt;00:18,  4.60it/s]
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>30240 rows at Support_Force above ± 0.43 m/yr
3 draining and 2 filling lakes found
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> 58%|█████▊    | 115/198 [00:31&lt;00:22,  3.62it/s]
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>96788 rows at Foundation above ± 0.43 m/yr
2 draining and 12 filling lakes found
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> 59%|█████▉    | 117/198 [00:32&lt;00:18,  4.45it/s]
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>20534 rows at Lambert above ± 0.41 m/yr
0 draining and 1 filling lakes found
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> 61%|██████    | 120/198 [00:32&lt;00:13,  5.57it/s]
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>19521 rows at Mellor above ± 0.48 m/yr
1 draining and 1 filling lakes found
9735 rows at Fisher above ± 0.49 m/yr
0 draining and 1 filling lakes found
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> 67%|██████▋   | 133/198 [00:33&lt;00:06, 10.45it/s]
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>9630 rows at Moller above ± 0.46 m/yr
1 draining and 0 filling lakes found
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> 68%|██████▊   | 135/198 [00:34&lt;00:10,  6.14it/s]
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>31449 rows at Institute above ± 0.47 m/yr
7 draining and 3 filling lakes found
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> 72%|███████▏  | 142/198 [00:35&lt;00:09,  5.61it/s]
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>30329 rows at Bowman_Strom_Live_Axel-Heigerg above ± 0.77 m/yr
2 draining and 0 filling lakes found
27320 rows at Sulzberger above ± 0.82 m/yr
1 draining and 0 filling lakes found
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> 74%|███████▎  | 146/198 [00:36&lt;00:16,  3.20it/s]
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>77210 rows at Getz above ± 1.55 m/yr
1 draining and 0 filling lakes found
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> 82%|████████▏ | 162/198 [00:39&lt;00:07,  4.55it/s]
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>64469 rows at Recovery above ± 0.43 m/yr
4 draining and 6 filling lakes found
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>100%|██████████| 198/198 [00:42&lt;00:00,  4.69it/s]
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Total of 193 subglacial lakes found
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="visualize-lakes">
<h2>Visualize lakes<a class="headerlink" href="#visualize-lakes" title="Permalink to this headline">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Concatenate XY points with labels, and move data from GPU to CPU</span>
<span class="n">X</span><span class="p">:</span> <span class="n">cudf</span><span class="o">.</span><span class="n">DataFrame</span> <span class="o">=</span> <span class="n">cudf</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">objs</span><span class="o">=</span><span class="p">[</span><span class="n">X</span><span class="p">,</span> <span class="n">lake_labels</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="s2">&quot;columns&quot;</span><span class="p">)</span>
<span class="n">X_</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">to_pandas</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Plot clusters on a map in colour, noise points/outliers as small dots</span>
<span class="n">fig</span> <span class="o">=</span> <span class="n">pygmt</span><span class="o">.</span><span class="n">Figure</span><span class="p">()</span>
<span class="n">n_clusters_</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">X_</span><span class="o">.</span><span class="n">cluster_id</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span> <span class="o">-</span> <span class="mi">1</span>  <span class="c1"># No. of clusters minus noise (NaN)</span>
<span class="n">sizes</span> <span class="o">=</span> <span class="p">(</span><span class="n">X_</span><span class="o">.</span><span class="n">cluster_id</span><span class="o">.</span><span class="n">isna</span><span class="p">())</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">arg</span><span class="o">=</span><span class="p">{</span><span class="kc">True</span><span class="p">:</span> <span class="mf">0.01</span><span class="p">,</span> <span class="kc">False</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">})</span>
<span class="n">pygmt</span><span class="o">.</span><span class="n">makecpt</span><span class="p">(</span><span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;polar&quot;</span><span class="p">,</span> <span class="n">series</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">color_model</span><span class="o">=</span><span class="s2">&quot;+cDrain,Fill&quot;</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
    <span class="n">x</span><span class="o">=</span><span class="n">X_</span><span class="o">.</span><span class="n">x</span><span class="p">,</span>
    <span class="n">y</span><span class="o">=</span><span class="n">X_</span><span class="o">.</span><span class="n">y</span><span class="p">,</span>
    <span class="n">sizes</span><span class="o">=</span><span class="n">sizes</span><span class="p">,</span>
    <span class="n">style</span><span class="o">=</span><span class="s2">&quot;cc&quot;</span><span class="p">,</span>
    <span class="n">color</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">cut</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">X_</span><span class="o">.</span><span class="n">cluster_id</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">),</span> <span class="n">labels</span><span class="o">=</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]),</span>
    <span class="n">cmap</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">frame</span><span class="o">=</span><span class="p">[</span>
        <span class="sa">f</span><span class="s1">&#39;WSne+t&quot;Estimated number of lake clusters at </span><span class="si">{</span><span class="n">basin</span><span class="o">.</span><span class="n">NAME</span><span class="si">}</span><span class="s1">: </span><span class="si">{</span><span class="n">n_clusters_</span><span class="si">}</span><span class="s1">&quot;&#39;</span><span class="p">,</span>
        <span class="s1">&#39;xafg+l&quot;Polar Stereographic X (m)&quot;&#39;</span><span class="p">,</span>
        <span class="s1">&#39;yafg+l&quot;Polar Stereographic Y (m)&quot;&#39;</span><span class="p">,</span>
    <span class="p">],</span>
<span class="p">)</span>
<span class="n">basinx</span><span class="p">,</span> <span class="n">basiny</span> <span class="o">=</span> <span class="n">basin</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">exterior</span><span class="o">.</span><span class="n">coords</span><span class="o">.</span><span class="n">xy</span>
<span class="n">fig</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">basinx</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">basiny</span><span class="p">,</span> <span class="n">pen</span><span class="o">=</span><span class="s2">&quot;thinnest,-&quot;</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">position</span><span class="o">=</span><span class="s1">&#39;JMR+w2c/0.5c+m+n&quot;Unclassified&quot;&#39;</span><span class="p">,</span> <span class="n">L</span><span class="o">=</span><span class="s2">&quot;i0.5c&quot;</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">fname</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;figures/subglacial_lake_clusters_at_</span><span class="si">{</span><span class="n">basin</span><span class="o">.</span><span class="n">NAME</span><span class="si">}</span><span class="s2">.png&quot;</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="select-a-subglacial-lake-to-examine">
<h2>Select a subglacial lake to examine<a class="headerlink" href="#select-a-subglacial-lake-to-examine" title="Permalink to this headline">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Load dhdt data from Parquet file</span>
<span class="n">placename</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;siple_coast&quot;</span>  <span class="c1"># &quot;slessor_downstream&quot;  #  &quot;Recovery&quot;  # &quot;Whillans&quot;</span>
<span class="n">df_dhdt</span><span class="p">:</span> <span class="n">cudf</span><span class="o">.</span><span class="n">DataFrame</span> <span class="o">=</span> <span class="n">cudf</span><span class="o">.</span><span class="n">read_parquet</span><span class="p">(</span>
    <span class="sa">f</span><span class="s2">&quot;ATLXI/df_dhdt_</span><span class="si">{</span><span class="n">placename</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="si">}</span><span class="s2">.parquet&quot;</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Choose one Antarctic active subglacial lake polygon with EPSG:3031 coordinates</span>
<span class="n">lake_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;Whillans IX&quot;</span>
<span class="n">lake_catalog</span> <span class="o">=</span> <span class="n">deepicedrain</span><span class="o">.</span><span class="n">catalog</span><span class="o">.</span><span class="n">subglacial_lakes</span><span class="p">()</span>
<span class="n">lake_ids</span><span class="p">,</span> <span class="n">transect_id</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">pd</span><span class="o">.</span><span class="n">json_normalize</span><span class="p">(</span><span class="n">lake_catalog</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;lakedict&quot;</span><span class="p">])</span>
    <span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;lakename == @lake_name&quot;</span><span class="p">)[[</span><span class="s2">&quot;ids&quot;</span><span class="p">,</span> <span class="s2">&quot;transect&quot;</span><span class="p">]]</span>
    <span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="p">)</span>
<span class="n">lake</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">lake_catalog</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
    <span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">lake_ids</span><span class="p">]</span>
    <span class="o">.</span><span class="n">dissolve</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">lake_ids</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;int64&quot;</span><span class="p">),</span> <span class="n">as_index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
<span class="p">)</span>

<span class="n">region</span> <span class="o">=</span> <span class="n">deepicedrain</span><span class="o">.</span><span class="n">Region</span><span class="o">.</span><span class="n">from_gdf</span><span class="p">(</span><span class="n">gdf</span><span class="o">=</span><span class="n">lake</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">lake_name</span><span class="p">)</span>
<span class="n">draining</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="n">lake</span><span class="o">.</span><span class="n">inner_dhdt</span> <span class="o">&lt;</span> <span class="mi">0</span>

<span class="nb">print</span><span class="p">(</span><span class="n">lake</span><span class="p">)</span>
<span class="n">lake</span><span class="o">.</span><span class="n">geometry</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>index                                                         0
geometry      POLYGON ((-444731.6953220846 -545129.683759524...
basin_name                                             Whillans
refgtracks    74|135|196|266|327|388|577|638|769|830|1019|10...
num_points                                                 3422
maxabsdhdt                                             6.731061
inner_dhdt                                             1.152791
mean_dhdt                                              1.365484
outer_dhdt                                             0.338404
outer_std                                              0.151085
outer_mad                                              0.081393
Name: 0, dtype: object
</pre></div>
</div>
<img alt="../_images/04_dbscan_14_1.svg" src="../_images/04_dbscan_14_1.svg" /></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Subset data to lake of interest</span>
<span class="n">placename</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">region</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="s2">&quot;_&quot;</span><span class="p">)</span>
<span class="n">df_lake</span><span class="p">:</span> <span class="n">cudf</span><span class="o">.</span><span class="n">DataFrame</span> <span class="o">=</span> <span class="n">region</span><span class="o">.</span><span class="n">subset</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">df_dhdt</span><span class="p">)</span>
<span class="c1"># Get all raw xyz points and one transect line dataframe</span>
<span class="n">track_dict</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="n">deepicedrain</span><span class="o">.</span><span class="n">split_tracks</span><span class="p">(</span><span class="n">df</span><span class="o">=</span><span class="n">df_lake</span><span class="o">.</span><span class="n">to_pandas</span><span class="p">())</span>
<span class="n">track_points</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">track_dict</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
    <span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">])</span>
    <span class="o">.</span><span class="n">mean</span><span class="p">()</span>  <span class="c1"># z value is mean h_corr over all cycles</span>
    <span class="o">.</span><span class="n">reset_index</span><span class="p">()[[</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="s2">&quot;h_corr&quot;</span><span class="p">]]</span>
<span class="p">)</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">_rgt</span><span class="p">,</span> <span class="n">_pt</span> <span class="o">=</span> <span class="n">transect_id</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)</span>
    <span class="n">df_transect</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">track_dict</span><span class="p">[</span><span class="n">transect_id</span><span class="p">][[</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="s2">&quot;h_corr&quot;</span><span class="p">,</span> <span class="s2">&quot;cycle_number&quot;</span><span class="p">]]</span>
        <span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">])</span>
        <span class="o">.</span><span class="n">max</span><span class="p">()</span>  <span class="c1"># z value is maximum h_corr over all cycles</span>
        <span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
    <span class="p">)</span>
<span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
    <span class="k">pass</span>

<span class="c1"># Save lake outline to OGR GMT file format</span>
<span class="n">outline_points</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;figures/</span><span class="si">{</span><span class="n">placename</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">placename</span><span class="si">}</span><span class="s2">.gmt&quot;</span>
<span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="n">outline_points</span><span class="p">):</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;figures/</span><span class="si">{</span><span class="n">placename</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">lake_catalog</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">lake_ids</span><span class="p">)]</span><span class="o">.</span><span class="n">to_file</span><span class="p">(</span>
        <span class="n">filename</span><span class="o">=</span><span class="n">outline_points</span><span class="p">,</span> <span class="n">driver</span><span class="o">=</span><span class="s2">&quot;OGR_GMT&quot;</span>
    <span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>100%|██████████| 21/21 [00:00&lt;00:00, 36.83it/s]
</pre></div>
</div>
</div>
</div>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            kernelName: "python3",
            path: "./chapters"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

              </div>
              
            </main>
            <footer class="footer-article noprint">
                
    <!-- Previous / next buttons -->
<div class='prev-next-area'>
    <a class='left-prev' id="prev-link" href="data.html" title="previous page">
        <i class="fas fa-angle-left"></i>
        <div class="prev-next-info">
            <p class="prev-next-subtitle">previous</p>
            <p class="prev-next-title">Data Preparation</p>
        </div>
    </a>
    <a class='right-next' id="next-link" href="training.html" title="next page">
    <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Model Training</p>
    </div>
    <i class="fas fa-angle-right"></i>
    </a>
</div>
            </footer>
        </div>
    </div>
    <div class="footer-content row">
        <footer class="col footer"><p>
  
    By Wei Ji Leong, Jessica Scheick, Wilson Sauthoff<br/>
  
    <div class="extra_footer">
      <a rel="license" href="http://creativecommons.org/licenses/by/4.0/"><img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by/4.0/88x31.png" /></a><br />
This content is licensed under a
<a rel="license" href="http://creativecommons.org/licenses/by/4.0/">Creative Commons Attribution 4.0 International License</a>.

    </div>
</p>
        </footer>
    </div>
    
</div>


      </div>
    </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf"></script>


  </body>
</html>